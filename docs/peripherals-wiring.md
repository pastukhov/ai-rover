# Подключение периферии и deep sleep

## Разъёмы на RoverC Pro

### Grove I2C (x2) — на тележке
- **Пины:** G26 (SCL), G0 (SDA), 5V, GND
- Параллельные отводы той же I2C-шины, что управляет моторами (0x38)
- Подходят **только для I2C-устройств** (с отдельным адресом)
- **Нельзя** подключать PIR (цифровой) или UART-устройства — сломают обмен с моторами

### Servo (x2) — трёхштырьковые на тележке
- **Servo 1** (регистр `0x10`) — занят захватом (gripper)
- **Servo 2** (регистр `0x11`) — свободный
- Сигнал генерирует STM32 на RoverC, управление через I2C
- Это **выходы** PWM, для датчиков/камер не подходят

### Grove на M5StickC Plus — основной для периферии
- **Пины:** G32, G33, 5V, GND
- Оба пина — RTC GPIO (пригодны для deep sleep wakeup)
- Не заняты другими функциями
- Сюда подключаются PIR и UnitV

## Заказанные модули M5Stack

| Модуль | SKU | Цена | Интерфейс | I2C-адрес |
|--------|-----|------|-----------|-----------|
| PIR Motion Sensor (AS312) | U004 | $5.50 | Port B (GPIO, цифровой) | — |
| 4-Relay Unit | U097 | — | Port A (I2C) | 0x26 |
| Mini 3A Relay Unit | U023 | $3.50 | Port B (GPIO, цифровой) | — |

### Выбор реле

**4-Relay (I2C, 0x26)** — подключается к RoverC Grove, не тратит GPIO. Лучший вариант если нужно управление питанием UnitV без потери пинов G32/G33.

**Mini 3A Relay (GPIO)** — проще, один канал, управляется одним пином (HIGH/LOW). Можно подключить к G10 (LED, переназначаемый) если G32/G33 заняты. Или использовать вместо 4-Relay если I2C-шина перегружена.

## Схема подключения

```
M5StickC Plus Grove (G32, G33):
  ├─ G33 ← PIR (AS312) — цифровой вход, deep sleep wakeup
  └─ G32 ← UnitV TX — UART приём данных от камеры

RoverC Grove I2C (G26/G0, шина 0x38):
  └─ 4-Relay Unit (0x26) — реле #1 коммутирует 5V питание UnitV
```

### Распиновка Grove M5StickC Plus

| Пин   | Устройство          | Назначение                                    |
|-------|----------------------|-----------------------------------------------|
| G33   | PIR-сенсор (OUT)     | Цифровой вход, пробуждение из deep sleep      |
| G32   | UnitV TX → ESP32 RX  | Приём данных от камеры (полудуплексный UART)   |
| 5V    | Питание PIR           | Общее от Grove                                |
| GND   | Общая земля          |                                                |

### Распиновка 4-Relay на RoverC Grove

| Пин   | Функция              |
|-------|----------------------|
| G26   | SCL (I2C)            |
| G0    | SDA (I2C)            |
| 5V    | Питание реле         |
| GND   | Земля                |

Реле #1 (COM/ON) коммутирует 5V линию питания UnitV.

### Отправка команд к UnitV (опционально)
- UnitV может работать автономно (скрипт MaixPy при включении)
- Если нужен TX от ESP32 к UnitV — резисторный делитель на G33 с изоляцией от PIR, либо отдельный пин

## Сценарий работы

1. **Сон** — ESP32 deep sleep, PIR на G33 ждёт (~0.05 мА), UnitV обесточена (реле разомкнуто)
2. **Движение** → PIR выдаёт HIGH → G33 → ext1 ANY_HIGH → ESP32 просыпается
3. **Инициализация** → ESP32 поднимает WiFi, I2C → команда на реле (0x26) → включает питание UnitV
4. **UnitV грузится** → MaixPy скрипт → детекция → UART TX → ESP32 читает на G32
5. **Нет активности 30 сек** → ESP32 отключает реле (UnitV off) → deep sleep

## Deep sleep — текущая реализация

### Wakeup-источники
| Источник | GPIO | Механизм | Триггер |
|----------|------|----------|---------|
| BtnA     | 37   | ext0     | LOW (нажатие) |
| BtnB     | 39   | ext1 (ALL_LOW) | LOW (нажатие) |
| PIR (план) | 33 | ext1 (ANY_HIGH) | HIGH (движение) |

### Ограничения ext1 на ESP32 (оригинальном)
- Два режима: `ESP_EXT1_WAKEUP_ALL_LOW` или `ESP_EXT1_WAKEUP_ANY_HIGH`
- Нельзя смешивать ANY_HIGH и ALL_LOW в одной маске
- BtnA использует ext0 (поддерживает LOW-триггер отдельно)
- Для PIR (ANY_HIGH на G33) + BtnB (ALL_LOW на G39) — **нельзя** объединить в одну ext1-маску
- Решение: BtnA через ext0, PIR через ext1 (ANY_HIGH), BtnB — потерять или обработать иначе

### RTC GPIO на M5StickC Plus
Только RTC GPIO могут будить из deep sleep:
- G0, G2, G4, G12-G15, G25-G27, G32-G39 — все RTC
- **G32, G33** (Grove) — свободны, подходят
- **G37** (BtnA), **G39** (BtnB) — кнопки, RTC
- G26, G0 — заняты I2C моторов

## Энергопотребление

| Компонент | Активный режим | Спящий/выкл |
|-----------|---------------|-------------|
| ESP32 + WiFi | ~200 мА | ~10 мкА (deep sleep) |
| WiFi (MIN_MODEM) | ~70 мА (экономия) | — |
| RoverC STM32 + моторы (idle) | ~30 мА | нет sleep-регистра |
| UnitV-M12 (K210) | ~300–400 мА | нет low-power режима с детекцией |
| PIR-сенсор | ~0.05 мА | — |
| M5StickC Plus экран | ~20 мА | 0 (display.sleep) |

### Общий бюджет USB (500 мА макс)
- ESP32 + WiFi + экран + зарядка M5StickC: ~270 мА
- RoverC passthrough: ~30 мА idle
- UnitV: ~300–400 мА — **превышает бюджет** при одновременной зарядке

### Рекомендации
- UnitV включать только после пробуждения, не держать постоянно
- PIR — основной сенсор пробуждения (5000x экономичнее камеры)
- WiFi power saving (`esp_wifi_set_ps(WIFI_PS_MIN_MODEM)`) экономит ~130 мА
- Deep sleep через 30 сек неактивности
